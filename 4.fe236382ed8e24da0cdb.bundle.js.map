{"version":3,"file":"4.fe236382ed8e24da0cdb.bundle.js","sources":["webpack:///./src/unstable/components/JellyForm.tsx"],"sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar temen = require(\"balena-temen\");\nvar jellyschema = require(\"jellyschema\");\nvar cloneDeep = require(\"lodash/cloneDeep\");\nvar get = require(\"lodash/get\");\nvar isEqual = require(\"lodash/isEqual\");\nvar isPlainObject = require(\"lodash/isPlainObject\");\nvar merge = require(\"lodash/merge\");\nvar omit = require(\"lodash/omit\");\nvar set = require(\"lodash/set\");\nvar React = require(\"react\");\nvar Form_1 = require(\"./Form\");\nvar getFormulaKeys = function (obj, prefix) {\n    if (prefix === void 0) { prefix = ''; }\n    var keys = Object.keys(obj);\n    prefix = prefix ? prefix + '.' : '';\n    return keys.reduce(function (result, key) {\n        if (isPlainObject(obj[key])) {\n            result = result.concat(getFormulaKeys(obj[key], prefix + key));\n        }\n        else if (key === '$$formula') {\n            result.push(prefix + key);\n        }\n        return result;\n    }, []);\n};\nvar runFormulas = function (schema, value) {\n    var data = cloneDeep(value);\n    var keys = getFormulaKeys(schema).map(function (path) {\n        return {\n            formula: get(schema, path),\n            path: path.replace(/properties\\./g, ''),\n        };\n    });\n    keys.forEach(function (y) {\n        set(data, y.path, y.formula);\n    });\n    var evaluate;\n    try {\n        evaluate = temen.evaluate(data);\n    }\n    catch (e) {\n        console.error('Caught error when evaluating formulas', e);\n        evaluate = value;\n    }\n    return merge({}, value, evaluate);\n};\nvar computeFormSchemas = function (jellySchema, uiSchema) {\n    var computed = jellyschema.generateJsonAndUiSchema(jellySchema);\n    return {\n        schema: computed.jsonSchema,\n        uiSchema: merge({}, computed.uiSchema, uiSchema),\n    };\n};\nvar JellyForm = (function (_super) {\n    __extends(JellyForm, _super);\n    function JellyForm(props) {\n        var _this = _super.call(this, props) || this;\n        _this.onChange = function (changeData) {\n            var formData = changeData.formData;\n            var schema = _this.state.schema;\n            var data = cloneDeep(formData);\n            var evaluate = runFormulas(schema, data);\n            var result = merge({}, formData, evaluate);\n            _this.setState({ value: result });\n            if (_this.props.onFormChange) {\n                _this.props.onFormChange(__assign({}, changeData, { formData: result }));\n            }\n        };\n        var _a = computeFormSchemas(props.schema, props.uiSchema), schema = _a.schema, uiSchema = _a.uiSchema;\n        _this.state = {\n            value: props.value || {},\n            schema: schema,\n            uiSchema: uiSchema,\n        };\n        return _this;\n    }\n    JellyForm.prototype.componentWillReceiveProps = function (nextProps) {\n        if (!isEqual(this.props.value, nextProps.value)) {\n            this.setState({\n                value: runFormulas(this.state.schema, nextProps.value),\n            });\n        }\n        if (!isEqual(this.props.schema, nextProps.schema) ||\n            !isEqual(this.props.uiSchema, nextProps.uiSchema)) {\n            var _a = computeFormSchemas(nextProps.schema, nextProps.uiSchema), schema = _a.schema, uiSchema = _a.uiSchema;\n            this.setState({\n                schema: schema,\n                uiSchema: uiSchema,\n            });\n        }\n    };\n    JellyForm.prototype.render = function () {\n        var _a = this.state, value = _a.value, schema = _a.schema, uiSchema = _a.uiSchema;\n        var options = omit(this.props, [\n            'value',\n            'schema',\n            'uiSchema',\n            'onFormChange',\n        ]);\n        return (React.createElement(Form_1.default, __assign({ value: value, schema: schema, uiSchema: uiSchema, onFormChange: this.onChange }, options)));\n    };\n    return JellyForm;\n}(React.Component));\nexports.default = JellyForm;\n"],"mappings":"AACA","sourceRoot":""}